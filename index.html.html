<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PlanBuilder AI ‚Äî ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--indigo:#15803d;--violet:#d4af37}
    html,body{font-family:'Kanit',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji',sans-serif}
    .bg-grad{background:linear-gradient(135deg,var(--indigo),var(--violet))}
    .card{box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .step-active{background:#ecfdf5;border-color:#16a34a;color:#052e16}
    .tip{border-left:4px solid #16a34a;background:#f0fdf4}
    .warn{border-left:4px solid #f59e0b;background:#fffbeb}
    .danger{border-left:4px solid #ef4444;background:#fef2f2}
    details > summary{cursor:pointer}
    details[open] summary .chev{transform:rotate(90deg)}
    .chev{transition:transform .15s ease}
    @media print{.no-print{display:none!important} body{background:#fff}}
    .ai-btn{ position: absolute; bottom: 8px; right: 8px; background: linear-gradient(135deg, #4f46e5, #a259ff); color: white; border-radius: 9999px; width: 28px; height: 28px; display: grid; place-items: center; font-size: 1.1rem; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s ease; }
    .ai-btn:hover{ transform: scale(1.1); }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b sticky top-0 z-50 no-print">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-grad grid place-items-center text-white text-xl">üåæ</div>
        <div>
          <h1 class="text-xl font-bold text-gray-900">PlanBuilder AI</h1>
          <p class="text-xs text-gray-600 leading-tight">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ú‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏° AI ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-save" class="px-3 py-2 rounded-lg bg-green-700 text-white text-sm hover:bg-green-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="btn-load" class="px-3 py-2 rounded-lg bg-white border text-sm hover:bg-gray-50">‡πÇ‡∏´‡∏•‡∏î</button>
        <input id="load-file" type="file" accept="application/json" class="hidden" />
        <button id="btn-pdf" class="px-3 py-2 rounded-lg bg-amber-600 text-white text-sm hover:bg-amber-700">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF</button>
      </div>
    </div>
  </header>

  <nav class="no-print">
    <div class="max-w-7xl mx-auto px-4 py-4 grid grid-cols-2 md:grid-cols-4 gap-3">
      <button data-step="1" class="step-btn step-active border rounded-xl px-4 py-3 text-sm font-semibold flex items-center gap-2"><span>1</span><span>‡∏Ñ‡∏∏‡πâ‡∏°‡πÑ‡∏´‡∏° (Quick Check)</span></button>
      <button data-step="2" class="step-btn border rounded-xl px-4 py-3 text-sm font-semibold flex items-center gap-2"><span>2</span><span>One‚ÄëPage</span></button>
      <button data-step="3" class="step-btn border rounded-xl px-4 py-3 text-sm font-semibold flex items-center gap-2"><span>3</span><span>Business Plan (AI)</span></button>
      <button data-step="4" class="step-btn border rounded-xl px-4 py-3 text-sm font-semibold flex items-center gap-2"><span>4</span><span>‡∏™‡πà‡∏á/Export</span></button>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 pb-24">
    <section id="step-1" class="space-y-6">
      <div class="bg-white rounded-2xl p-6 card">
        <h2 class="text-lg font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
        <div class="grid md:grid-cols-3 gap-4 mt-2">
          <div>
            <label class="text-sm font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à/‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</label>
            <input id="biz-name" type="text" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î 50 ‡πÑ‡∏£‡πà">
          </div>
          <div>
            <label class="text-sm font-semibold">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô</label>
            <input id="biz-desc" type="text" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="‡∏à‡∏∞‡∏õ‡∏•‡∏π‡∏Å‡∏≠‡∏∞‡πÑ‡∏£/‡∏Ç‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏£ ‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£">
          </div>
          <div>
            <label class="text-sm font-semibold">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
            <input id="project-duration" type="number" min="1" step="1" value="1" class="calc-trigger mt-1 w-full border rounded-lg px-3 py-2">
            <p class="text-xs text-gray-500 mt-1">‡πÉ‡∏™‡πà "1" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡πÉ‡∏™‡πà "4" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î 1 ‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</p>
          </div>
        </div>
      </div>
      <div id="cashflow-warning" class="p-4 rounded-xl warn hidden">
        <div class="font-bold text-amber-900">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î!</div>
        <p class="text-sm text-amber-800 mt-1">‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ <strong class="underline">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á</strong> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢: <strong id="working-capital-amount" class="text-lg">‡∏ø0</strong></p>
      </div>
      <div class="bg-white rounded-2xl p-6 card">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô (<span class="dynamic-unit">/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>)</h3>
          <button id="add-product" class="px-3 py-2 rounded-lg bg-green-600 text-white text-sm hover:bg-green-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>
        <div id="products" class="space-y-3"></div>
      </div>
      <div class="bg-white rounded-2xl p-6 card grid md:grid-cols-2 gap-x-8 gap-y-6">
        <div>
          <h3 class="text-lg font-bold mb-2">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h3>
          <div class="flex items-center justify-between mb-2">
            <p class="text-xs text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏°‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>
            <button id="add-fixed" class="px-3 py-2 rounded-lg bg-rose-600 text-white text-sm hover:bg-rose-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</button>
          </div>
          <div id="fixed-costs" class="space-y-3"></div>
        </div>
        <div class="grid gap-6 content-start">
          <div>
            <label class="text-sm font-semibold">‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏Å)</label>
            <input id="capex" type="number" min="0" step="0.01" class="calc-trigger mt-1 w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô 180000">
            <p class="text-xs text-gray-500 mt-1">‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ</p>
          </div>
          <div>
            <label class="text-sm font-semibold">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (%)</label>
            <input id="hurdle" type="number" min="0" step="0.1" class="calc-trigger mt-1 w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5">
            <p class="text-xs text-gray-500 mt-1">‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£<span class="font-bold">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞‡∏Å‡∏µ‡πà % ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞ '‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢'?</p>
          </div>
        </div>
      </div>
      <div id="results-section" class="bg-white rounded-2xl p-6 card">
        <h3 class="text-lg font-bold mb-3">‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ</h3>
        <div class="grid md:grid-cols-4 gap-4">
          <div class="p-4 rounded-xl bg-gray-50"><div class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° <span class="dynamic-unit">/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div><div id="sum-revenue" class="text-2xl font-bold text-green-700">‡∏ø0</div></div>
          <div class="p-4 rounded-xl bg-gray-50"><div class="text-xs text-gray-500">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° <span class="dynamic-unit">/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div><div id="sum-costs" class="text-2xl font-bold text-rose-700">‡∏ø0</div></div>
          <div class="p-4 rounded-xl bg-gray-50"><div class="text-xs text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ <span class="dynamic-unit">/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div><div id="net-profit" class="text-2xl font-bold text-green-700">‡∏ø0</div></div>
          <div class="p-4 rounded-xl bg-gray-50"><div class="text-xs text-gray-500">‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div><div id="payback" class="text-2xl font-bold text-purple-700">‚Äì</div></div>
        </div>
        <div class="grid md:grid-cols-4 gap-4 mt-4">
          <div class="p-3 rounded-lg border"><div class="text-xs text-gray-500">‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (ROI)</div><div id="roi" class="text-lg font-bold">0%</div></div>
          <div class="p-3 rounded-lg border"><div class="text-xs text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div id="avg-profit-month" class="text-lg font-bold text-blue-700">‡∏ø0</div></div>
          <div class="p-3 rounded-lg border"><div class="text-xs text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div id="status" class="text-lg font-bold">‚Äî</div></div>
          <div class="p-3 rounded-lg border"><div class="text-xs text-gray-500">‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div id="hurdle-view" class="text-lg font-semibold">‡πÄ‡∏õ‡πâ‡∏≤ 0%</div></div>
        </div>
        <div id="advice" class="mt-4 p-4 rounded-xl text-sm"></div>
      </div>
      <div class="no-print flex justify-end gap-3">
        <button data-step-to="2" class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm">‡πÑ‡∏õ Step 2 ‚Üí</button>
      </div>
    </section>

    <section id="step-2" class="space-y-6 hidden">
      <div class="bg-white rounded-2xl p-6 card">
        <h3 class="text-lg font-bold mb-2">One‚ÄëPage Summary</h3>
        <p class="text-sm text-gray-600 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô 1 ‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤/‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå</p>
        <div class="mt-4 grid md:grid-cols-2 gap-4">
          <textarea id="op-left" class="w-full h-48 border rounded-lg p-3" placeholder="‡∏õ‡∏±‡∏ç‡∏´‡∏≤ & ‡πÇ‡∏ã‡∏•‡∏π‡∏ä‡∏±‡∏ô / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ / ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á"></textarea>
          <textarea id="op-right" class="w-full h-48 border rounded-lg p-3" placeholder="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ & ‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á / ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏°"></textarea>
        </div>
      </div>
      <div class="no-print flex justify-between">
        <button data-step-to="1" class="px-4 py-2 rounded-lg border text-sm">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button data-step-to="3" class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm">‡πÑ‡∏õ Step 3 ‚Üí</button>
      </div>
    </section>

    <section id="step-3" class="space-y-6 hidden">
      <div class="bg-white rounded-2xl p-6 card">
        <h3 class="text-lg font-bold mb-2">‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (AI Assistant)</h3>
        <p class="text-sm text-gray-600 mb-4">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚ú® ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏ö</p>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <h4 class="font-bold text-green-800 border-b pb-2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå (Strategy)</h4>
            <div class="relative">
              <label class="font-semibold">1. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏≠‡∏Å‡∏≤‡∏™</label>
              <textarea id="bp-1" class="w-full h-32 border rounded-lg p-3 mt-1 text-sm" placeholder="- ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï&#10;- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£&#10;- ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô"></textarea>
              <button class="ai-btn" data-target="bp-1" data-topic="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡πÇ‡∏≠‡∏Å‡∏≤‡∏™">‚ú®</button>
            </div>
            <div class="relative">
              <label class="font-semibold">2. ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</label>
              <textarea id="bp-2" class="w-full h-32 border rounded-lg p-3 mt-1 text-sm" placeholder="- ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£&#10;- ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏≠‡∏∞‡πÑ‡∏£&#10;- ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î: ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£"></textarea>
              <button class="ai-btn" data-target="bp-2" data-topic="‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î">‚ú®</button>
            </div>
          </div>
          <div class="space-y-4">
            <h4 class="font-bold text-green-800 border-b pb-2">‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ (Operations)</h4>
            <div class="relative">
              <label class="font-semibold">3. ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</label>
              <textarea id="bp-3" class="w-full h-32 border rounded-lg p-3 mt-1 text-sm" placeholder="- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÜ ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô&#10;- ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà)&#10;- ‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏∞‡πÑ‡∏£"></textarea>
              <button class="ai-btn" data-target="bp-3" data-topic="‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô">‚ú®</button>
            </div>
            <div class="relative">
              <label class="font-semibold">4. ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
              <textarea id="bp-4" class="w-full h-32 border rounded-lg p-3 mt-1 text-sm" placeholder="- ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏≠‡∏∞‡πÑ‡∏£&#10;- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô 3, 6, 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£&#10;- (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å Step 1)"></textarea>
              <button class="ai-btn" data-target="bp-4" data-topic="‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢">‚ú®</button>
            </div>
          </div>
        </div>
        <details class="mt-6 rounded-xl p-4 tip">
            <summary class="flex items-center gap-2 font-semibold"><span class="chev">‚ñ∂</span> ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠</summary>
            <div class="mt-2 text-sm space-y-2">
              <p>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏â‡∏ö‡∏±‡∏ö‡∏¢‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</p>
              <p class="font-semibold">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô‡∏Ç‡∏≠‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏î‡∏°‡∏ó‡∏∏‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏¥‡πà‡∏á:</p>
              <ul class="list-disc pl-5 mt-1">
                <li><strong class="text-rose-600">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Financial Plan):</strong> ‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (‡∏á‡∏ö‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô, ‡∏á‡∏ö‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î) ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3-5 ‡∏õ‡∏µ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</li>
                <li><strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Management Team):</strong> ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡πÅ‡∏ô‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠</li>
              </ul>
            </div>
          </details>
      </div>
      <div class="no-print flex justify-between">
        <button data-step-to="2" class="px-4 py-2 rounded-lg border text-sm">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button data-step-to="4" class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm">‡πÑ‡∏õ Step 4 ‚Üí</button>
      </div>
    </section>

    <section id="step-4" class="space-y-6 hidden">
      <div class="bg-white rounded-2xl p-6 card">
        <h3 class="text-lg font-bold mb-2">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å / ‡πÅ‡∏ä‡∏£‡πå</h3>
        <p class="text-sm text-gray-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå, ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡∏ï‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô PDF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏£‡πå</p>
        <div class="mt-4 flex gap-2 no-print">
          <button id="btn-save-2" class="px-3 py-2 rounded-lg bg-green-700 text-white text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (.json)</button>
          <button id="btn-pdf-2" class="px-3 py-2 rounded-lg bg-amber-600 text-white text-sm">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF</button>
        </div>
      </div>
      <div class="no-print">
        <button data-step-to="3" class="px-4 py-2 rounded-lg border text-sm">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
    </section>
  </main>
  
  <div id="cost-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
      <div class="p-4 border-b flex justify-between items-center">
        <h3 class="font-bold text-lg">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "<span id="modal-product-name"></span>"</h3>
        <button id="btn-close-modal" class="text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
      </div>
      <div class="p-4 max-h-64 overflow-y-auto space-y-2" id="modal-cost-items"></div>
      <div class="p-4 border-t space-y-2">
        <button id="btn-add-modal-item" class="w-full px-3 py-2 rounded-lg border text-sm hover:bg-gray-50">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</button>
        <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
          <span class="font-semibold">‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢:</span>
          <span id="modal-total-cost" class="font-bold text-lg text-rose-600">‡∏ø0.00</span>
        </div>
        <button id="btn-apply-cost" class="w-full px-3 py-2 rounded-lg bg-green-700 text-white hover:bg-green-800">‡∏ï‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ</button>
      </div>
    </div>
  </div>

  <div id="ai-loading-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg p-6 flex items-center gap-4 shadow-xl">
      <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
      <span class="text-lg font-semibold">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô...</span>
    </div>
  </div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ===== UTILITY & FORMATTING =====
        const F = (n) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0 }).format(n);
        const Fp = (n) => n.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%';
        
        // ===== DOM ELEMENTS =====
        const productsEl = document.getElementById('products');
        const fixedEl = document.getElementById('fixed-costs');
        const costModal = document.getElementById('cost-modal');
        let targetCostInput = null;
        const stepBtns = document.querySelectorAll('.step-btn');
        const sections = { 1: document.getElementById('step-1'), 2: document.getElementById('step-2'), 3: document.getElementById('step-3'), 4: document.getElementById('step-4') };

        // ===== START OF AI ASSISTANT CONFIGURATION =====
        const API_KEY = 'YOUR_GOOGLE_AI_API_KEY'; // <--- PASTE YOUR KEY HERE
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;
        const aiLoadingModal = document.getElementById('ai-loading-modal');

        async function callAI(targetTextarea, topic) {
            if (!API_KEY || API_KEY === 'YOUR_GOOGLE_AI_API_KEY') {
                alert('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á Google AI Studio ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ YOUR_GOOGLE_AI_API_KEY ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î)');
                return;
            }

            aiLoadingModal.classList.remove('hidden');

            const businessData = collectData();
            const userInput = targetTextarea.value;

            const prompt = `
              ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û (Business Consultant) ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ú‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
              ‡∏à‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${topic}"
              ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô:

              **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à:**
              - ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à: ${businessData.bizName || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)'}
              - ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢: ${businessData.bizDesc || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)'}
              - ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å: ${businessData.products.map(p => p.name).filter(Boolean).join(', ') || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)'}
              - ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${F(businessData.capex) || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)'}
              - ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${F( (businessData.capex * businessData.hurdle) / 100 ) || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)'}

              **‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≠‡∏ô (‡∏´‡∏≤‡∏Å‡∏°‡∏µ):**
              "${userInput || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡πâ‡∏≠‡∏ô‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'}"

              **‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î:**
              - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏ô‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô
              - ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö..."
              - ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡πâ‡∏≠‡∏ô‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${topic}" ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à
            `;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 800,
                        },
                    }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ AI');
                }

                const data = await response.json();
                // Check if candidates array and its content exist to prevent errors
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    targetTextarea.value = aiText.trim();
                } else {
                    throw new Error('AI ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á');
                }

            } catch (error) {
                console.error('AI Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                aiLoadingModal.classList.add('hidden');
            }
        }
        // ===== END OF AI ASSISTANT CONFIGURATION =====


        // ===== UI UPDATE LOGIC =====
        function updateLabels() {
            const duration = +document.getElementById('project-duration').value || 1;
            const unitText = duration > 1 ? '/‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' : '/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
            document.querySelectorAll('.dynamic-unit').forEach(el => { el.textContent = unitText; });
            document.querySelectorAll('.p-qty-label').forEach(el => { el.textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô${unitText}`; });
        }
        function updateCashflowWarning(monthlyFixed, duration) {
            const warningEl = document.getElementById('cashflow-warning');
            if (duration > 1 && monthlyFixed > 0) {
                const requiredCapital = monthlyFixed * (duration - 1);
                document.getElementById('working-capital-amount').textContent = F(requiredCapital);
                warningEl.classList.remove('hidden');
            } else {
                warningEl.classList.add('hidden');
            }
        }

        // ===== CALCULATION ENGINE =====
        function calculateCore(data) {
            let revenue = 0, varCosts = 0;
            data.products.forEach(p => { revenue += (p.price * p.qty); varCosts += (p.cost * p.qty); });
            const monthlyFixedCosts = data.fixed.reduce((sum, f) => sum + f.amt, 0);
            const totalFixedCosts = monthlyFixedCosts * data.duration;
            const totalCosts = varCosts + totalFixedCosts;
            const netProfit = revenue - totalCosts;
            const avgProfitPerMonth = data.duration > 0 ? netProfit / data.duration : 0;
            const payback = (data.capex > 0 && avgProfitPerMonth > 0) ? data.capex / avgProfitPerMonth : 0;
            const avgMonthlyRoi = (data.capex > 0) ? (avgProfitPerMonth / data.capex) * 100 : 0;
            return { revenue, totalCosts, netProfit, payback, avgMonthlyRoi, avgProfitPerMonth, monthlyFixedCosts };
        }
        function calculateResults() {
            updateLabels();
            const data = collectData();
            const results = calculateCore(data);
            document.getElementById('sum-revenue').textContent = F(results.revenue);
            document.getElementById('sum-costs').textContent = F(results.totalCosts);
            document.getElementById('net-profit').textContent = F(results.netProfit);
            document.getElementById('avg-profit-month').textContent = F(results.avgProfitPerMonth);
            document.getElementById('payback').textContent = results.payback > 0 ? results.payback.toFixed(1) : '‚Äì';
            document.getElementById('roi').textContent = Fp(results.avgMonthlyRoi);
            updateStatusAndAdvice(results, data);
            updateCashflowWarning(results.monthlyFixedCosts, data.duration);
        }
        function updateStatusAndAdvice(results, data) {
            const statusEl = document.getElementById('status'), adviceEl = document.getElementById('advice'), hurdleViewEl = document.getElementById('hurdle-view');
            hurdleViewEl.textContent = `‡πÄ‡∏õ‡πâ‡∏≤ ${data.hurdle}%`;
            let status, advice, statusColor, adviceBg;
            if (results.avgMonthlyRoi >= data.hurdle && data.hurdle > 0) {
                status = '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'; advice = '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô! ‡πÅ‡∏ú‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏°‡∏µ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï';
                statusColor = 'text-green-700 font-bold'; adviceBg = 'bg-green-50 text-green-800';
            } else if (results.avgProfitPerMonth > 0) {
                status = '‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ'; advice = '‡∏°‡∏µ‡∏Å‡∏≥‡πÑ‡∏£ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡πÑ‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô';
                statusColor = 'text-amber-700'; adviceBg = 'bg-amber-50 text-amber-800';
            } else if (results.revenue > 0) {
                status = '‡∏ô‡πà‡∏≤‡∏Å‡∏±‡∏á‡∏ß‡∏• (‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)'; advice = '‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô! ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏ç‡πà!';
                statusColor = 'text-rose-700 font-bold'; adviceBg = 'bg-rose-50 text-rose-800';
            } else {
                status = '‚Äî'; advice = '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤';
                statusColor = 'text-gray-800'; adviceBg = 'bg-gray-50 text-gray-800';
            }
            statusEl.textContent = status; statusEl.className = `text-lg font-bold ${statusColor}`;
            adviceEl.innerHTML = advice; adviceEl.className = `mt-4 p-4 rounded-xl text-sm ${adviceBg}`;
        }
        
        // ===== DYNAMIC ROWS & EVENT HANDLING =====
        function addProductRow(p={}){
          const row = document.createElement('div');
          row.className = 'product-row grid grid-cols-12 gap-2 items-center border rounded-xl p-3';
          const duration = +document.getElementById('project-duration').value || 1;
          const unitText = duration > 1 ? '/‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' : '/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
          row.innerHTML = `<div class="col-span-12 md:col-span-4"><label class="text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label><input class="p-name w-full border rounded-lg px-3 py-2" value="${p.name||''}"></div> <div class="col-span-6 md:col-span-2"><label class="text-xs text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input type="number" step="0.01" class="p-price w-full border rounded-lg px-3 py-2 calc-trigger" value="${p.price||''}"></div> <div class="col-span-6 md:col-span-3"><label class="text-xs text-gray-500">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><div class="flex items-center gap-1"><input type="number" step="0.01" class="p-cost w-full border rounded-lg px-3 py-2 calc-trigger" value="${p.cost||''}"><button class="btn-calc-cost p-2 rounded-md bg-gray-100 hover:bg-gray-200 text-xs">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button></div></div> <div class="col-span-6 md:col-span-2"><label class="p-qty-label text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô${unitText}</label><input type="number" step="1" class="p-qty w-full border rounded-lg px-3 py-2 calc-trigger" value="${p.qty||''}"></div> <div class="col-span-6 md:col-span-1 self-end"><button class="remove w-full px-3 py-2 rounded-lg bg-white border hover:bg-gray-50">‡∏•‡∏ö</button></div>`;
          row.querySelector('.remove').addEventListener('click',()=>{row.remove(); calculateResults();});
          row.querySelector('.btn-calc-cost').addEventListener('click', () => openCostModal(row));
          productsEl.appendChild(row);
          attachListeners();
        }
        function addFixedRow(f={}){
          const row = document.createElement('div');
          row.className = 'fixed-row grid grid-cols-12 gap-3 border rounded-xl p-3 items-end';
          row.innerHTML = `<div class="col-span-8"><label class="text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input class="f-name w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" value="${f.name||''}"></div> <div class="col-span-3"><label class="text-xs text-gray-500">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="number" step="0.01" class="f-amt w-full border rounded-lg px-3 py-2 calc-trigger" value="${f.amt||''}"></div> <button class="remove col-span-1 px-3 py-2 rounded-lg bg-white border hover:bg-gray-50">‡∏•‡∏ö</button>`;
          row.querySelector('.remove').addEventListener('click',()=>{row.remove(); calculateResults();});
          fixedEl.appendChild(row);
          attachListeners();
        }
        function attachListeners() {
            document.querySelectorAll('.calc-trigger').forEach(el => {
                el.removeEventListener('input', calculateResults);
                el.addEventListener('input', calculateResults);
            });
        }

        // ===== MODAL LOGIC =====
        function openCostModal(productRow) {
          targetCostInput = productRow.querySelector('.p-cost');
          document.getElementById('modal-product-name').textContent = productRow.querySelector('.p-name').value || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ';
          const itemsContainer = document.getElementById('modal-cost-items');
          itemsContainer.innerHTML = ''; addModalCostRow(); addModalCostRow();
          calculateModalTotal(); costModal.classList.remove('hidden');
        }
        function closeCostModal() { costModal.classList.add('hidden'); }
        function addModalCostRow() {
          const itemsContainer = document.getElementById('modal-cost-items');
          const row = document.createElement('div');
          row.className = 'grid grid-cols-12 gap-2';
          row.innerHTML = `<input class="modal-item-name col-span-7 border rounded-md px-2 py-1 text-sm" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö A)"> <input type="number" step="0.01" class="modal-item-cost col-span-4 border rounded-md px-2 py-1 text-sm" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤"> <button class="modal-item-remove col-span-1 text-red-500 hover:bg-red-100 rounded-md font-bold">√ó</button>`;
          row.querySelector('.modal-item-cost').addEventListener('input', calculateModalTotal);
          row.querySelector('.modal-item-remove').addEventListener('click', () => { row.remove(); calculateModalTotal(); });
          itemsContainer.appendChild(row);
        }
        function calculateModalTotal() {
          const costs = Array.from(document.querySelectorAll('.modal-item-cost')).reduce((total, el) => total + (+el.value || 0), 0);
          document.getElementById('modal-total-cost').textContent = F(costs);
        }
        
        // ===== STEPPER LOGIC =====
        function goStep(n){
          Object.values(sections).forEach(s=>s.classList.add('hidden'));
          sections[n]?.classList.remove('hidden');
          stepBtns.forEach(b=>b.classList.remove('step-active'));
          document.querySelector(`[data-step="${n}"]`)?.classList.add('step-active');
          window.scrollTo({top:0,behavior:'smooth'});
        }
        
        // ===== SAVE/LOAD/PDF LOGIC =====
        function collectData(){
          return {
            bizName: document.getElementById('biz-name')?.value||'', bizDesc: document.getElementById('biz-desc')?.value||'',
            duration: +document.getElementById('project-duration')?.value || 1,
            products: Array.from(document.querySelectorAll('.product-row')).map(r=>({ name: r.querySelector('.p-name')?.value||'', price: +(r.querySelector('.p-price')?.value||0), cost: +(r.querySelector('.p-cost')?.value||0), qty: +(r.querySelector('.p-qty')?.value||0) })),
            fixed: Array.from(document.querySelectorAll('.fixed-row')).map(r=>({ name: r.querySelector('.f-name')?.value||'', amt: +(r.querySelector('.f-amt')?.value||0) })),
            capex: +(document.getElementById('capex')?.value||0), hurdle: +(document.getElementById('hurdle')?.value||0),
            onepage: {left: document.getElementById('op-left')?.value||'', right: document.getElementById('op-right')?.value||''},
            bp: { bp1: document.getElementById('bp-1')?.value||'', bp2: document.getElementById('bp-2')?.value||'', bp3: document.getElementById('bp-3')?.value||'', bp4: document.getElementById('bp-4')?.value||'' }
          };
        }
        function applyData(d){
          document.getElementById('biz-name').value = d.bizName||''; document.getElementById('biz-desc').value = d.bizDesc||'';
          document.getElementById('project-duration').value = d.duration || 1;
          productsEl.innerHTML=''; (d.products||[]).forEach(addProductRow);
          fixedEl.innerHTML=''; (d.fixed||[]).forEach(addFixedRow);
          document.getElementById('capex').value = d.capex||0; document.getElementById('hurdle').value = d.hurdle||0;
          document.getElementById('op-left').value = d.onepage?.left||''; document.getElementById('op-right').value = d.onepage?.right||'';
          if (d.bp) {
            document.getElementById('bp-1').value = d.bp.bp1||''; document.getElementById('bp-2').value = d.bp.bp2||'';
            document.getElementById('bp-3').value = d.bp.bp3||''; document.getElementById('bp-4').value = d.bp.bp4||'';
          }
          calculateResults();
        }
        function download(filename, text) {
          const el = document.createElement('a');
          el.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(text));
          el.setAttribute('download', filename);
          el.style.display = 'none'; document.body.appendChild(el); el.click(); document.body.removeChild(el);
        }
        function exportPDF(){
          const opt = { margin: 0.5, filename: 'PlanBuilder-AI.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas:  { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
          // Temporarily hide AI buttons for PDF export
          document.querySelectorAll('.ai-btn').forEach(btn => btn.style.display = 'none');
          html2pdf().from(document.body).set(opt).save().then(() => {
            // Show AI buttons again after PDF is created
            document.querySelectorAll('.ai-btn').forEach(btn => btn.style.display = 'grid');
          });
        }

        // ===== INITIALIZATION & ALL EVENT LISTENERS =====
        addProductRow(); addFixedRow();
        attachListeners();
        calculateResults();
        
        document.getElementById('add-product')?.addEventListener('click',()=>addProductRow());
        document.getElementById('add-fixed')?.addEventListener('click',()=>addFixedRow());
        
        stepBtns.forEach(b=>b.addEventListener('click',()=>goStep(b.dataset.step)));
        document.querySelectorAll('[data-step-to]')?.forEach(el=>el.addEventListener('click',()=>goStep(el.dataset.stepTo)));

        document.getElementById('btn-save')?.addEventListener('click',()=>download('planbuilder-data.json', JSON.stringify(collectData(), null, 2)));
        document.getElementById('btn-save-2')?.addEventListener('click',()=>download('planbuilder-data.json', JSON.stringify(collectData(), null, 2)));
        const loadBtn = document.getElementById('btn-load');
        const loadFile = document.getElementById('load-file');
        loadBtn?.addEventListener('click',()=>loadFile.click());
        loadFile?.addEventListener('change', (e)=>{
          const file = e.target.files[0]; if(!file) return;
          const reader = new FileReader();
          reader.onload = (ev)=>{ try{ const data = JSON.parse(ev.target.result); applyData(data); } catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); } };
          reader.readAsText(file);
        });
        document.getElementById('btn-pdf')?.addEventListener('click', exportPDF);
        document.getElementById('btn-pdf-2')?.addEventListener('click', exportPDF);

        document.getElementById('btn-close-modal').addEventListener('click', closeCostModal);
        document.getElementById('btn-add-modal-item').addEventListener('click', addModalCostRow);
        document.getElementById('btn-apply-cost').addEventListener('click', () => {
          const total = Array.from(document.querySelectorAll('.modal-item-cost')).reduce((total, el) => total + (+el.value || 0), 0);
          if (targetCostInput) {
            targetCostInput.value = total.toFixed(2);
            targetCostInput.dispatchEvent(new Event('input', { bubbles: true }));
          }
          closeCostModal();
        });

        // Add event listeners for AI buttons
        document.querySelectorAll('.ai-btn').forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.target;
                const topic = button.dataset.topic;
                const targetTextarea = document.getElementById(targetId);
                callAI(targetTextarea, topic);
            });
        });
    });
</script>
</body>
</html>